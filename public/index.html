<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>-->
    <script src="js/vendor/jquery.js"></script>
    <script src="js/vendor/what-input.js"></script>
    <script src="js/vendor/foundation.js"></script>
    <script src="js/app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5PCX2zq3GujBeukoNjsPgte0zD16t14c"> </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.7.4/d3.js"> </script>

      
<!--      <script src='https://api.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.js'></script>-->
<!--<link href='https://api.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.css' rel='stylesheet' />-->


    <script src="js/date.format.js"></script>
    <link rel="stylesheet" href="css/foundation.css">
      <link rel="stylesheet/less" type="text/css" href="css/app.less" />
      <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.7.2/less.min.js"></script>


</head>
<body>
<div class="off-canvas-wrapper">
<div class="off-canvas position-left" id="offCanvas" data-off-canvas >
    <div id = 'sessions' ></div>
</div>
<div class="off-canvas position-bottom" id="offCanvasRight" data-off-canvas data-transition="overlap">
    <div id = 'sensors' ></div>
</div>    


 <div class="off-canvas-content" data-off-canvas-content>
     <button type="button" class="button" data-toggle="offCanvas" style="position:absolute;">Trips</button>
<button type="button" style= "bottom: 0px; position: absolute; left:50%; transform:translateX(-50%); z-index:1;" class="button" data-toggle="offCanvasRight">Sensors</button>
            <div id = 'chart'  style='width: 100%; height: 30vh;'></div>
            <div id='map'  style='width: 100%; height: 60vh;'></div>
    </div>
</div>
</body>
<!--
    
<body>
    

     <div class="row">
        <div class="large-3  columns ">      
            <div id = 'sessions' ></div>
        </div>
        <div class="large-3  columns ">      
            <div id = 'sensors' ></div>
        </div>
        <div class="large-6 columns clearfix"> 
            <div id = 'chart'></div>
            <div id='map'  style='width: 900px; height: 500px;'></div>
        </div>
     </div>
</body>
-->
    
<script>
    $(document).foundation();
    
    if (!Foundation.MediaQuery.atLeast('large')) {
             $('.button').addClass('large')
    }else{
        $('.position-bottom').addClass('position-right')
             $('.position-right').removeClass('position-bottom')
    }
    
   var map;
   var map_items = [];
   var sessions;        
   var meta;        
    $(document).ready(function(){
 
    
         $.getJSON( "http://mikekorostelev.com/sessions",
                  {
                  },
                  function( res ) {
             meta = res.meta
             console.log(res)
             res.sessions.reverse()
             sessions = res.sessions
                    $.each(sessions, function(i,ses){
                        var date = new Date(null);
                        date.setSeconds(ses/1000 + 3600)
                        date = date.format('m/d/yy h:MM TT')
                         var $btn = $('<div>').html(date + ' | ' + meta[ses].distance.toFixed(2) + ' miles' + ' | ' + (meta[ses].time/60).toFixed(2) + ' mins').attr('id','session_btn_'+ses)
                            .attr('style', '    margin: 0 0 0.2rem 0;')
                            .attr('class', 'button expanded session_btn')
                            .on('click', function(){
                                display(ses)
                            })
                        if (!Foundation.MediaQuery.atLeast('large')) {
                             $btn.addClass('large')
                        }
                        $('#sessions').append($btn)
                        
                    })
                    display(sessions[0])
                })
   
        
      
        
        
    })
    
    function display(session){
        $('.session_btn').removeClass('success')
        $('#session_btn_'+session).addClass('success')
        
       $.getJSON( "http://mikekorostelev.com/data",
                  {
                    session: session
                  },
                  function( res ) {
                //console.log(res)
                    
                    _.each(res.data, function(value, key) {
                        value['lat'] = Number(value.kff1006);
                        value['lng'] = Number(value.kff1005);
                        value['time'] = value.time.$date
                    });
           
                    res.data = _.sortBy(res.data,'time')
                    //console.log(res.data)
           
                    $('#sensors').empty()
                    $.each(res.sensors, function(i,s){
                         var $btn = $('<div>').html(s.name).attr('id', 'sensor_btn_'+s.id)
                            .attr('style', '    margin: 0 0 0.2rem 0;')
                            .attr('class', 'button expanded sensor_btn')
                            .on('click', function(){
                                console.log(s)
                                initMap(res.data,s['id'])
                            })
                         
                         console.log(Foundation.MediaQuery.current)
                         if (!Foundation.MediaQuery.atLeast('large')) {
                             $btn.addClass('large')
                        }
                        
                        $('#sensors').append($btn)
                        
                    })
//                    mapBoxMap(res.data,res.sensors)
                    initMap(res.data,'kff1001',true)
                    
                    
                    
                })
    }

        
    function initMap(data,variable, init) {
        $('.sensor_btn').removeClass('success')
        $('#sensor_btn_'+variable).addClass('success')
        
        
        if(init){
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: data[data.length%2],
          mapTypeId: 'terrain'
        });
        }else{
            _.each(map_items,function(i){
                i.setMap(null)
            })
            map_items = []
        }
//        variable = 'kff1239'
          
        _.each(data, function(m){ m[variable] = Number(m[variable])})
        var extracted = _.pluck(data,variable)
        $.each(extracted, function(i, m){  extracted[i] = Number(m)})
          console.log(extracted)
        var _range = ["red",  "lightgreen"];
        var color = d3.scaleLinear()
        .domain([d3.min(extracted),d3.max(extracted)])
        .range(_range)
        
        var lines = [];
        var colors = []
        var buf = [data[0]]
        var last = data[0]
        _.each(data, function(m){
            if (color(last[variable]) == color(m[variable])){
               buf.push(m)  
            }else{
                lines.push(buf)   
                colors.push(color(m[variable]))
                buf = [last, m];
            }
            last =  _.clone(m)
            
        })
         $.each(lines,function(i,line){
              var PathStyle = new google.maps.Polyline({
                path: line,
                strokeColor:colors[i],
                strokeOpacity: 1.0,
                strokeWeight: 10,
                map: map
              });
             map_items.push(PathStyle)
          })

          
          
          
          
          
          
          
          
          
          




        var margin = {top: 30, right: 10, bottom: 30, left: 30},
            width = $('#chart').width() - margin.left - margin.right,
            height = $('#chart').height() - margin.top - margin.bottom;

            var a = new Date(null);
                a.setSeconds(data[0].time/1000 +3600)
            
            var b = new Date(null);
                b.setSeconds(data[data.length-1].time/1000 +3600)
            
            
        var x = d3.scaleTime()
            .domain([a, b])
            .range([0, width]);

        var y = d3.scaleLinear()
            .range([height, 0]);
        
		$('#chart').empty()
        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


          y.domain([d3.min(data, function(d) { return d[variable]; }), d3.max(data, function(d) { return d[variable]; })]);

          svg.append("g")
              .attr("class", "axis axis--x")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom()
                  .scale(x)
                  .tickFormat(d3.utcFormat("%I:%M %p")));

           
            
            
          svg.append("g")
              .attr("class", "dots")
            .selectAll("path")
              .data(data)
            .enter().append("path")
              .attr("transform", function(d) {
              
                      if(isNaN(d[variable])){
                        return "translate(" + x(d.time) + "," + y(0) + ")"
                          }else{
                            var a = new Date(null);
                            a.setSeconds(d.time/1000 +3600)
              return "translate(" + x(a) + "," + y(d[variable]) + ")"
                          };
          })
              .attr("d", d3.symbol()
                  .size(40));

          var tick = svg.append("g")
              .attr("class", "axis axis--y")
              .call(d3.axisLeft()
                  .scale(y)
                  .tickSize(-width)
                  )
            .select(".tick:last-of-type");

          var title = tick.append("text")
              .attr("dy", ".32em")
              .text("tweets per hour");

          tick.select("line")
              .attr("x1", title.node().getBBox().width + 6);

            
            
            
            
            var line = d3.line()
            .x(function(d) { 
                
                var a = new Date(null);
                a.setSeconds(d.time/1000 +3600)
                return x(a); })
            .y(function(d) { 
                if(isNaN(d[variable]))
                    return y(d3.min(extracted))
                else
                    return y(d[variable]); });

            
    svg.append("path")
     .datum(data)
      .attr("class", "line")
      .attr("d", line);
            
            
        function type(d) {
          d.rate = +d.count / 327 * 60; // January 8 to November 30
//          d.time = parseTime(d.time);
          d.time.setUTCHours((d.time.getUTCHours() + 24 - 7) % 24);
          return d;
        }

          
          
          
          
          
          
          
      }
        
        
   
      

    </script>

</html>